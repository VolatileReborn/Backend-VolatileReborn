<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SquareServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">demo</a> &gt; <a href="index.source.html" class="el_package">com.example.BackendVolatile.serviceImpl</a> &gt; <span class="el_source">SquareServiceImpl.java</span></div><h1>SquareServiceImpl.java</h1><pre class="source lang-java linenums">package com.example.BackendVolatile.serviceImpl;

import com.example.BackendVolatile.dao.taskDAO.Task;
import com.example.BackendVolatile.dto.squareDTO.EmployeeTaskDetailDTO;
import com.example.BackendVolatile.dto.squareDTO.TaskDetailDTO;
import com.example.BackendVolatile.mapper.task.SelectTaskMapper;
import com.example.BackendVolatile.mapper.task.TaskMapper;
import com.example.BackendVolatile.service.SquareService;
import com.example.BackendVolatile.util.ParameterValidityVerification;
import com.example.BackendVolatile.util.constant.*;
import com.example.BackendVolatile.util.pythonUtil.PythonUtil;
import com.example.BackendVolatile.util.pythonUtil.getRecommendedTaskUtil.GetRecommendedTaskDTO;
import com.example.BackendVolatile.util.pythonUtil.getRecommendedTaskUtil.GetRecommendedTaskUtil;
import com.example.BackendVolatile.util.pythonUtil.prepareTaskRecommendationTrainingDataUtil.PrepareTaskRecommendationTrainingDataDTO;
import com.example.BackendVolatile.util.pythonUtil.prepareTaskRecommendationTrainingDataUtil.PrepareTaskRecommendationTrainingDataUtil;
import com.example.BackendVolatile.util.pythonUtil.prepareTrainingDataUtil.PrepareTrainingDataDTO;
import com.example.BackendVolatile.util.pythonUtil.prepareTrainingDataUtil.PrepareTrainingDataUtil;
import com.example.BackendVolatile.vo.ResultVO;
import com.example.BackendVolatile.vo.squareVO.BrowserTasksVO;
import com.example.BackendVolatile.vo.squareVO.VisitorBrowserTasksVO;
import com.example.BackendVolatile.vo.squareVO.EmployeeTaskDetailVO;
import com.example.BackendVolatile.vo.squareVO.TaskDetailVO;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import javax.annotation.Resource;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

@Service
<span class="fc" id="L32">public class SquareServiceImpl implements SquareService {</span>

    @Resource
    TaskMapper taskMapper;

    @Resource
    SelectTaskMapper selectTaskMapper;

    @Resource
    ParameterValidityVerification parameterValidityVerification;

    @Resource
    PrepareTrainingDataUtil prepareTrainingDataUtil;

    @Resource
    RestTemplate restTemplate;

    @Resource
    GetRecommendedTaskUtil getRecommendedTaskUtil;

    @Resource
    PrepareTaskRecommendationTrainingDataUtil pTaskRecommend;

    /**
     * 调用者：无登录状态游客
     * 业务逻辑：用户在浏览大厅浏览任务，后端返回给前端所有正在进行中的任务
     */
    @Override
    public VisitorBrowserTasksVO visitorBrowserTasks(){
<span class="nc" id="L61">        VisitorBrowserTasksVO visitorBrowserTasksVO = new VisitorBrowserTasksVO();</span>
<span class="nc" id="L62">        List&lt;Task&gt; taskList = taskMapper.get_one_state_all_tasks_without_paging(TaskStateConstant.UNDERTAKING.getCode());</span>
<span class="nc" id="L63">        List&lt;Integer&gt; indexList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        for (int i = 0; i &lt; taskList.size(); i++) {</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if(taskList.get(i).getWorker_num_left() == 0){</span>
<span class="nc" id="L66">                indexList.add(i);</span>
            }
        }
<span class="nc bnc" id="L69" title="All 2 branches missed.">        for (int i = indexList.size() - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L70">            taskList.remove((int) indexList.get(i));</span>
        }
<span class="nc" id="L72">        visitorBrowserTasksVO.setTaskList(taskList);</span>
<span class="nc" id="L73">        visitorBrowserTasksVO.setResponse(new ResultVO(ResponseConstant.REQUEST_DATA_SUCCEEDED));</span>
<span class="nc" id="L74">        return visitorBrowserTasksVO;</span>
    }

    /**
     * 调用者：employee
     * 业务逻辑：众包工人在浏览大厅浏览任务，后端返回给前端所有正在进行中的任务
     */
    @Override
    public BrowserTasksVO browserTasks(){// 个性化推荐任务
//        BrowserTasksVO browserTasksVO = new BrowserTasksVO();
//        List&lt;Task&gt; taskList = taskMapper.get_one_state_all_tasks_without_paging(TaskStateConstant.UNDERTAKING.getCode());
//        List&lt;Integer&gt; indexList = new ArrayList&lt;&gt;();
//        for (int i = 0; i &lt; taskList.size(); i++) {
//            if(taskList.get(i).getWorker_num_left() == 0){
//                indexList.add(i);
//            }
//        }
//        for (int i = indexList.size() - 1; i &gt;= 0; i--) {
//            taskList.remove((int) indexList.get(i));
//        }
//        browserTasksVO.setTaskList(taskList);
//        browserTasksVO.setResponse(new ResultVO(ResponseConstant.REQUEST_DATA_SUCCEEDED));
//        return browserTasksVO;
//        return visitorBrowserTasksVO;



<span class="nc" id="L101">            BrowserTasksVO browserTasksVO = new BrowserTasksVO();</span>

<span class="nc" id="L103">            Map&lt;String, Object&gt; tokenVerification =</span>
<span class="nc" id="L104">                    parameterValidityVerification.tokenVerification(RoleConstant.EMPLOYEE.getRole());</span>
<span class="nc" id="L105">            ResultVO resultVO = (ResultVO) tokenVerification.get(VerificationMapConstant.RESULTVO.getStr());</span>
<span class="nc" id="L106">            Long valid = (Long) tokenVerification.get(VerificationMapConstant.VALID.getStr());</span>
<span class="nc" id="L107">            Long userId = (Long) tokenVerification.get(VerificationMapConstant.USERID.getStr());</span>

<span class="nc bnc" id="L109" title="All 2 branches missed.">            if (valid != BooleanValue.TRUE) {</span>
<span class="nc" id="L110">                browserTasksVO.setResponse(resultVO);</span>
<span class="nc" id="L111">                return browserTasksVO;</span>
            }

<span class="nc" id="L114">            List&lt;Task&gt; taskList = taskMapper.get_one_state_all_tasks_without_paging(TaskStateConstant.UNDERTAKING.getCode());</span>
<span class="nc" id="L115">            List&lt;Integer&gt; indexList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            for (int i = 0; i &lt; taskList.size(); i++) {</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                if (selectTaskMapper.is_selected(taskList.get(i).getTask_id(), userId) == BooleanValue.TRUE) {</span>
<span class="nc" id="L118">                    indexList.add(i);</span>
                }
<span class="nc bnc" id="L120" title="All 2 branches missed.">                else if(taskList.get(i).getWorker_num_left() == 0){</span>
<span class="nc" id="L121">                    indexList.add(i);</span>
                }
            }
<span class="nc bnc" id="L124" title="All 2 branches missed.">            for (int i = indexList.size() - 1; i &gt;= 0; i--) {</span>
<span class="nc" id="L125">                taskList.remove((int) indexList.get(i));</span>
            }
<span class="nc" id="L127">            browserTasksVO.setTaskList(taskList);</span>
<span class="nc" id="L128">            browserTasksVO.setResponse(new ResultVO(ResponseConstant.REQUEST_DATA_SUCCEEDED));</span>
<span class="nc" id="L129">            return browserTasksVO;</span>
//            try {
//            //开始个性化推荐
//            //
//                String prepareUrl = &quot;http://&quot;+PythonServerConstant.IP+ &quot;:&quot;+PythonServerConstant.PORT+&quot;/prepareTaskRecommendationTrainingData&quot;;
//                PrepareTaskRecommendationTrainingDataDTO pDTO = pTaskRecommend.getPrepareTaskRecommendationTrainingDataDTO();
//                String s = restTemplate.postForObject(prepareUrl, pDTO, String.class);
//                System.out.println(s);
//            if (s == null || !s.equals(&quot;\&quot;Task Data Prepared Successfully\&quot;&quot;)) {
//                browserTasksVO.setTaskList(taskList);
//                browserTasksVO.setResponse(new ResultVO(ResponseConstant.REQUEST_DATA_SUCCEEDED));
//                return browserTasksVO;
//            } else {
//                System.out.println(&quot;开始推荐-------------&quot;);
//                String gurl = &quot;http://&quot;+PythonServerConstant.IP+ &quot;:&quot;+PythonServerConstant.PORT+&quot;/getRecommendedTasks&quot;;
//                GetRecommendedTaskDTO getRecommendedTaskDTO = getRecommendedTaskUtil.getRecommendedTask(userId);
//                System.out.println(getRecommendedTaskDTO.toString());
//                String res = restTemplate.postForObject(gurl, getRecommendedTaskDTO, String.class);
//                if(res.startsWith(&quot;[{&quot;)){
//                    System.out.println(&quot;res&quot; + res);
//                    List&lt;Long&gt; rcmdTaskIdList = getRecommendedTaskUtil.parse(res);
//                    System.out.println(rcmdTaskIdList.toString());
//                    List&lt;Task&gt; rcmdTaskList = new ArrayList&lt;&gt;();
//                    System.out.println(&quot;第一步:&quot; + rcmdTaskList.toString());
//                    for(int i=0;i&lt;rcmdTaskIdList.size();i++){
//                        if(taskMapper.task_id_exist(rcmdTaskIdList.get(i)) == BooleanValue.TRUE &amp;&amp;
//                                taskMapper.get_state_by_task_id(rcmdTaskIdList.get(i)) == TaskStateConstant.UNDERTAKING.getCode() &amp;&amp;
//                              taskMapper.get_worker_num_left_by_task_id(rcmdTaskIdList.get(i)) !=0){
//                            rcmdTaskList.add(taskMapper.get_by_task_id(rcmdTaskIdList.get(i)));
//                        }
//                    }
//                    List&lt;Integer&gt; remove = new ArrayList&lt;&gt;();
//                    for(int i=0;i&lt;taskList.size();i++){
//                        if(rcmdTaskIdList.contains(taskList.get(i).getTask_id())){
//                            remove.add(i);
//                        }
//                    }
//                    for(int i=remove.size()-1;i&gt;=0;i--){
//                        taskList.remove((int)remove.get(i));
//                    }
//                    System.out.println(&quot;第二步:&quot; + rcmdTaskList.toString());
//                    rcmdTaskList.addAll(taskList);
//                    browserTasksVO.setTaskList(rcmdTaskList);
//                    System.out.println(&quot;推荐列表:&quot;  + rcmdTaskList.toString());
//                    browserTasksVO.setResponse(new ResultVO(ResponseConstant.REQUEST_DATA_SUCCEEDED));
//                    return browserTasksVO;
//                }
//                else{
//                    browserTasksVO.setTaskList(taskList);
//                    browserTasksVO.setResponse(new ResultVO(ResponseConstant.REQUEST_DATA_SUCCEEDED));
//                    return browserTasksVO;
//                }
//            }
//        }catch (Exception e){
//                browserTasksVO.setTaskList(taskList);
//                browserTasksVO.setResponse(new ResultVO(ResponseConstant.REQUEST_DATA_SUCCEEDED));
//                return browserTasksVO;
//        }

    }

    /**
     * 调用者：employee
     * 业务逻辑：众包工人在任务广场点击一个任务查看任务详情，后端返回任务情况以及该用户是否是否已经参与
     */
    @Override
    public EmployeeTaskDetailVO employeeTaskDetail(EmployeeTaskDetailDTO employeeTaskDetailDTO){
<span class="nc" id="L196">        EmployeeTaskDetailVO employeeTaskDetailVO = new EmployeeTaskDetailVO();</span>
<span class="nc" id="L197">        Map&lt;String, Object&gt; tokenVerification =</span>
<span class="nc" id="L198">                parameterValidityVerification.tokenVerification(RoleConstant.EMPLOYEE.getRole());</span>
<span class="nc" id="L199">        ResultVO resultVO = (ResultVO)tokenVerification.get(VerificationMapConstant.RESULTVO.getStr());</span>
<span class="nc" id="L200">        Long valid = (Long)tokenVerification.get(VerificationMapConstant.VALID.getStr());</span>
<span class="nc" id="L201">        Long userId = (Long)tokenVerification.get(VerificationMapConstant.USERID.getStr());</span>

<span class="nc bnc" id="L203" title="All 2 branches missed.">        if(valid != BooleanValue.TRUE){</span>
<span class="nc" id="L204">            employeeTaskDetailVO.setResponse(resultVO);</span>
<span class="nc" id="L205">            return employeeTaskDetailVO;</span>
        }

<span class="nc" id="L208">        Long taskId = employeeTaskDetailDTO.getTaskId();</span>
<span class="nc" id="L209">        Task task = taskMapper.get_by_task_id(taskId);</span>
<span class="nc" id="L210">        employeeTaskDetailVO.setTask(task);</span>
<span class="nc" id="L211">        employeeTaskDetailVO.setIsSelected(selectTaskMapper.is_selected(taskId,userId));</span>
<span class="nc" id="L212">        employeeTaskDetailVO.setResponse(new ResultVO(ResponseConstant.REQUEST_DATA_SUCCEEDED));</span>
<span class="nc" id="L213">        return employeeTaskDetailVO;</span>
    }

    /**
     * 调用者：employer/visitor/admin
     * 业务逻辑：接包方在人任务广场浏览任务是点击任务查看任务详情，系统给用户返回对应任务的一些信息
     */
    @Override
    public TaskDetailVO taskDetail(TaskDetailDTO taskDetailDTO){
<span class="nc" id="L222">        TaskDetailVO taskDetailVO =  new TaskDetailVO();</span>
<span class="nc" id="L223">        Long taskId = taskDetailDTO.getTaskId();</span>
<span class="nc" id="L224">        Task task = taskMapper.get_by_task_id(taskId);//可以查看不是自己的任务</span>
<span class="nc" id="L225">        taskDetailVO.setTask(task);</span>
<span class="nc" id="L226">        taskDetailVO.setResponse(new ResultVO(ResponseConstant.REQUEST_DATA_SUCCEEDED));</span>
<span class="nc" id="L227">        return taskDetailVO;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>