<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmployerServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">demo</a> &gt; <a href="index.source.html" class="el_package">com.example.BackendVolatile.serviceImpl</a> &gt; <span class="el_source">EmployerServiceImpl.java</span></div><h1>EmployerServiceImpl.java</h1><pre class="source lang-java linenums">package com.example.BackendVolatile.serviceImpl;

import com.example.BackendVolatile.dao.reportDAO.*;
import com.example.BackendVolatile.dao.taskDAO.ExecutableFile;
import com.example.BackendVolatile.dao.taskDAO.RequirementDescriptionFile;
import com.example.BackendVolatile.dao.taskDAO.Task;
import com.example.BackendVolatile.dto.employerDTO.*;
import com.example.BackendVolatile.mapper.report.*;
import com.example.BackendVolatile.mapper.task.ExecutableFileMapper;
import com.example.BackendVolatile.mapper.task.RequirementDescriptionFileMapper;
import com.example.BackendVolatile.mapper.task.TaskMapper;
import com.example.BackendVolatile.service.EmployerService;
import com.example.BackendVolatile.util.ParameterValidityVerification;
import com.example.BackendVolatile.util.ScoreUtil;
import com.example.BackendVolatile.util.constant.*;
import com.example.BackendVolatile.vo.employerVO.*;
import com.example.BackendVolatile.vo.ResultVO;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.List;
import java.util.Map;

@Service
<span class="fc" id="L25">public class EmployerServiceImpl implements EmployerService {</span>

    @Resource
    TaskMapper taskMapper;

    @Resource
    ExecutableFileMapper executableFileMapper;

    @Resource
    RequirementDescriptionFileMapper requirementDescriptionFileMapper;

    @Resource
    ReportMapper reportMapper;

    @Resource
    DefectPictureMapper defectPictureMapper;

    @Resource
    ParameterValidityVerification parameterValidityVerification;

    @Resource
    CooperationReportMapper cooperationReportMapper;

    @Resource
    CooperationDefectPictureMapper cooperationDefectPictureMapper;

    @Resource
    ReportScoreMapper reportScoreMapper;

    @Resource
    ScoreUtil scoreUtil;

    /**
     * 调用者：employer
     * 业务逻辑：发包方在个人中心浏览正在进行中的任务，后端返回该发包方发布的，所有正在进行中的任务
     * @return
     */
    @Override
    public BrowserUndertakingTasksVO browserUndertakingTasks(){
<span class="nc" id="L64">        BrowserUndertakingTasksVO browserUndertakingTasksVO = new BrowserUndertakingTasksVO();</span>

<span class="nc" id="L66">        Map&lt;String, Object&gt; tokenVerification =</span>
<span class="nc" id="L67">                parameterValidityVerification.tokenVerification(RoleConstant.EMPLOYER.getRole());</span>
<span class="nc" id="L68">        ResultVO resultVO = (ResultVO)tokenVerification.get(VerificationMapConstant.RESULTVO.getStr());</span>
<span class="nc" id="L69">        Long valid = (Long)tokenVerification.get(VerificationMapConstant.VALID.getStr());</span>
<span class="nc" id="L70">        Long userId = (Long)tokenVerification.get(VerificationMapConstant.USERID.getStr());</span>

<span class="nc bnc" id="L72" title="All 2 branches missed.">        if(valid != BooleanValue.TRUE){</span>
<span class="nc" id="L73">            browserUndertakingTasksVO.setResponse(resultVO);</span>
<span class="nc" id="L74">            return browserUndertakingTasksVO;</span>
        }

<span class="nc" id="L77">        List&lt;Task&gt; taskList = taskMapper.get_one_state_tasks_by_user_id_without_paging(userId,</span>
<span class="nc" id="L78">                TaskStateConstant.UNDERTAKING.getCode());</span>
<span class="nc" id="L79">        browserUndertakingTasksVO.setUndertakingTaskList(taskList);</span>
<span class="nc" id="L80">        browserUndertakingTasksVO.setResponse(new ResultVO(ResponseConstant.EMPLOYER_SUCCEEDED));</span>
<span class="nc" id="L81">        return browserUndertakingTasksVO;</span>

    }

    /**
     * 调用者：employer
     * 业务逻辑：发包方在个人中心浏览停止招募的任务列表，后端返回该用户发布的所有停止招募的任务的信息
     * @return
     */
    @Override
    public BrowserFinishedTasksVO browserFinishedTasks(){
<span class="nc" id="L92">        BrowserFinishedTasksVO browserFinishedTasksVO = new BrowserFinishedTasksVO();</span>
<span class="nc" id="L93">        Map&lt;String, Object&gt; tokenVerification =</span>
<span class="nc" id="L94">                parameterValidityVerification.tokenVerification(RoleConstant.EMPLOYER.getRole());</span>
<span class="nc" id="L95">        ResultVO resultVO = (ResultVO)tokenVerification.get(VerificationMapConstant.RESULTVO.getStr());</span>
<span class="nc" id="L96">        Long valid = (Long)tokenVerification.get(VerificationMapConstant.VALID.getStr());</span>
<span class="nc" id="L97">        Long userId = (Long)tokenVerification.get(VerificationMapConstant.USERID.getStr());</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">        if(valid != BooleanValue.TRUE){</span>
<span class="nc" id="L100">            browserFinishedTasksVO.setResponse(resultVO);</span>
<span class="nc" id="L101">            return browserFinishedTasksVO;</span>
        }

<span class="nc" id="L104">        List&lt;Task&gt; taskList = taskMapper.get_one_state_tasks_by_user_id_without_paging(userId,</span>
<span class="nc" id="L105">                TaskStateConstant.FINISHED.getCode());</span>
<span class="nc" id="L106">        browserFinishedTasksVO.setFinishedTaskList(taskList);</span>
<span class="nc" id="L107">        browserFinishedTasksVO.setResponse(new ResultVO(ResponseConstant.EMPLOYER_SUCCEEDED));</span>
<span class="nc" id="L108">        return browserFinishedTasksVO;</span>
    }

    /**
     * 调用者：employer/admin
     * 业务逻辑：发包方在个人中心查看任务详情，后端校验该任务是不是该用户发布的，并返回对应任务的详细数据
     * @param browserTaskDetailDTO
     * @return
     */
    @Override
    public BrowserTaskDetailVO browserTaskDetail(BrowserTaskDetailDTO browserTaskDetailDTO){
<span class="nc" id="L119">        BrowserTaskDetailVO browserTaskDetailVO = new BrowserTaskDetailVO();</span>

<span class="nc" id="L121">        int[] roleList = new int[]{RoleConstant.EMPLOYER.getRole(),RoleConstant.ADMIN.getRole()};</span>
<span class="nc" id="L122">        Map&lt;String, Object&gt; tokenVerification =</span>
<span class="nc" id="L123">                parameterValidityVerification.tokenVerification(roleList);</span>
<span class="nc" id="L124">        ResultVO resultVO = (ResultVO)tokenVerification.get(VerificationMapConstant.RESULTVO.getStr());</span>
<span class="nc" id="L125">        Long valid = (Long)tokenVerification.get(VerificationMapConstant.VALID.getStr());</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">        if(valid != BooleanValue.TRUE){</span>
<span class="nc" id="L128">            browserTaskDetailVO.setResponse(resultVO);</span>
<span class="nc" id="L129">            return browserTaskDetailVO;</span>
        }

<span class="nc" id="L132">        Long taskId = browserTaskDetailDTO.getTaskId();</span>
<span class="nc" id="L133">        Task task = taskMapper.get_by_task_id(taskId);</span>
<span class="nc" id="L134">        browserTaskDetailVO.setTaskPartDetail(task);</span>

<span class="nc" id="L136">        List&lt;ExecutableFile&gt; executableFileList =</span>
<span class="nc" id="L137">                executableFileMapper.get_all_by_task_id_without_paging(taskId);</span>
<span class="nc" id="L138">        browserTaskDetailVO.setExecutableFileList(executableFileList);</span>

<span class="nc" id="L140">        List&lt;RequirementDescriptionFile&gt; requirementDescriptionFileList =</span>
<span class="nc" id="L141">                requirementDescriptionFileMapper.get_all_by_task_id_without_paging(taskId);</span>
<span class="nc" id="L142">        browserTaskDetailVO.setRequirementDescriptionFileList(requirementDescriptionFileList);</span>

<span class="nc" id="L144">        browserTaskDetailVO.setResponse(new ResultVO(ResponseConstant.EMPLOYER_SUCCEEDED));</span>
<span class="nc" id="L145">        return browserTaskDetailVO;</span>
    }

    /**
     * 调用者：employer
     * 业务逻辑：发包方将招募中的任务状态改变为停止招募，在此之前要检验该任务是不是进行中，是不是该用户发布的
     * @param browserCheckedDTO
     * @return
     */
    @Override
    public BrowserCheckedVO browserChecked(BrowserCheckedDTO browserCheckedDTO){
<span class="nc" id="L156">        BrowserCheckedVO browserCheckedVO = new BrowserCheckedVO();</span>

<span class="nc" id="L158">        Map&lt;String, Object&gt; tokenVerification =</span>
<span class="nc" id="L159">                parameterValidityVerification.tokenVerification(RoleConstant.EMPLOYER.getRole());</span>
<span class="nc" id="L160">        ResultVO resultVO = (ResultVO)tokenVerification.get(VerificationMapConstant.RESULTVO.getStr());</span>
<span class="nc" id="L161">        Long valid = (Long)tokenVerification.get(VerificationMapConstant.VALID.getStr());</span>
<span class="nc" id="L162">        Long userId = (Long)tokenVerification.get(VerificationMapConstant.USERID.getStr());</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">        if(valid != BooleanValue.TRUE){</span>
<span class="nc" id="L165">            browserCheckedVO.setResponse(resultVO);</span>
<span class="nc" id="L166">            return browserCheckedVO;</span>
        }

<span class="nc" id="L169">        Long taskId = browserCheckedDTO.getTaskId();</span>
        //taskExistenceAndBelonging的值无用，但在调用时会判断该任务是否属于userId，如果不属于就会报错
<span class="nc" id="L171">        Integer taskExistenceAndBelonging = taskMapper.get_task_existence_by_user_id_and_task_id(taskId,userId);</span>
        //isUndertaking 的值无用，但会在调用时判断taskId是否是进行中，如果不是就会报错
<span class="nc" id="L173">        Integer isUndertaking = taskMapper.task_is_undertaking(taskId,TaskStateConstant.UNDERTAKING.getCode());</span>
<span class="nc" id="L174">        taskMapper.update_task_state(taskId,TaskStateConstant.FINISHED.getCode());</span>
<span class="nc" id="L175">        browserCheckedVO.setResponse(new ResultVO(ResponseConstant.EMPLOYER_UPDATE_TASK_STATE_SUCCEEDED));</span>
<span class="nc" id="L176">        return browserCheckedVO;</span>
    }

    /**
     * 调用者：employer/admin
     * 业务逻辑：发包方在个人中心查看报告细节，后端验证报告存在，且属于对应任务，然后返回报告的相关信息
     * @param reportDetailDTO
     * @return
     */
    @Override
    public ReportDetailVO reportDetail(ReportDetailDTO reportDetailDTO){
<span class="nc" id="L187">        ReportDetailVO reportDetailVO = new ReportDetailVO();</span>

<span class="nc" id="L189">        int[] roleList = new int[]{RoleConstant.EMPLOYER.getRole(),RoleConstant.ADMIN.getRole()};</span>
<span class="nc" id="L190">        Map&lt;String, Object&gt; tokenVerification =</span>
<span class="nc" id="L191">                parameterValidityVerification.tokenVerification(roleList);</span>
<span class="nc" id="L192">        ResultVO resultVO = (ResultVO)tokenVerification.get(VerificationMapConstant.RESULTVO.getStr());</span>
<span class="nc" id="L193">        Long valid = (Long)tokenVerification.get(VerificationMapConstant.VALID.getStr());</span>
<span class="nc" id="L194">        Long userId = (Long)tokenVerification.get(VerificationMapConstant.USERID.getStr());</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">        if(valid != BooleanValue.TRUE){</span>
<span class="nc" id="L197">            reportDetailVO.setResponse(resultVO);</span>
<span class="nc" id="L198">            return reportDetailVO;</span>
        }
<span class="nc" id="L200">        Long reportId = reportDetailDTO.getReportId();</span>

<span class="nc" id="L202">        Report report = reportMapper.get_by_report_id(reportId);</span>
<span class="nc" id="L203">        reportDetailVO.setPartReportInfo(report);</span>
<span class="nc" id="L204">        List&lt;DefectPicture&gt; defectPictureList = defectPictureMapper.get_all_by_report_id(reportId);</span>
<span class="nc" id="L205">        reportDetailVO.setDefectPictureList(defectPictureList);</span>

<span class="nc" id="L207">        Integer scoreInIt = reportScoreMapper.score_in_it_by_user_id_and_report_id(userId,reportId);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if(scoreInIt == 0){</span>
<span class="nc" id="L209">            reportDetailVO.setIsScored(0);</span>
        }
        else{
<span class="nc" id="L212">            reportDetailVO.setIsScored(1);</span>
<span class="nc" id="L213">            ReportScore reportScore = reportScoreMapper.get_by_user_id_and_report_id(userId, reportId);</span>
<span class="nc" id="L214">            reportDetailVO.setScoreInfo(reportScore);</span>
        }

<span class="nc" id="L217">        List&lt;Integer&gt; scoreTemp = reportScoreMapper.get_score_by_report_id(reportId);</span>
<span class="nc" id="L218">        Integer totalScore = scoreUtil.calTotalScore(scoreTemp);</span>
<span class="nc" id="L219">        reportDetailVO.setTotalScore(totalScore);</span>


<span class="nc" id="L222">        reportDetailVO.setResponse(new ResultVO(ResponseConstant.EMPLOYER_SUCCEEDED));</span>
<span class="nc" id="L223">        return reportDetailVO;</span>
    }

    /**
     * 调用者：employer/admin
     * 业务逻辑：根据协作报告id查看协作报告细节
     * @param cooperationReportDetailDTO
     * @return
     */
    @Override
    public CooperationReportDetailVO cooperationReportDetail(CooperationReportDetailDTO cooperationReportDetailDTO){
<span class="nc" id="L234">        CooperationReportDetailVO cooperationReportDetailVO = new CooperationReportDetailVO();</span>

<span class="nc" id="L236">        int[] roleList = new int[]{RoleConstant.EMPLOYER.getRole(),RoleConstant.ADMIN.getRole()};</span>
<span class="nc" id="L237">        Map&lt;String, Object&gt; tokenVerification =</span>
<span class="nc" id="L238">                parameterValidityVerification.tokenVerification(roleList);</span>
<span class="nc" id="L239">        ResultVO resultVO = (ResultVO)tokenVerification.get(VerificationMapConstant.RESULTVO.getStr());</span>
<span class="nc" id="L240">        Long valid = (Long)tokenVerification.get(VerificationMapConstant.VALID.getStr());</span>

<span class="nc bnc" id="L242" title="All 2 branches missed.">        if(valid != BooleanValue.TRUE){</span>
<span class="nc" id="L243">            cooperationReportDetailVO.setResponse(resultVO);</span>
<span class="nc" id="L244">            return cooperationReportDetailVO;</span>
        }

<span class="nc" id="L247">        Long reportId = cooperationReportDetailDTO.getCooperationReportId();</span>

<span class="nc" id="L249">        CooperationReport cooperationReport = cooperationReportMapper.get_by_report_id(reportId);</span>

<span class="nc" id="L251">        cooperationReportDetailVO.setPartCooperationReportDetail(cooperationReport);</span>
<span class="nc" id="L252">        List&lt;CooperationDefectPicture&gt; cooperationDefectPictureList =</span>
<span class="nc" id="L253">                cooperationDefectPictureMapper.get_all_by_report_id(reportId);</span>
<span class="nc" id="L254">        cooperationReportDetailVO.setDefectPictureList(cooperationDefectPictureList);</span>
<span class="nc" id="L255">        cooperationReportDetailVO.setResponse(new ResultVO(ResponseConstant.REQUEST_DATA_SUCCEEDED));</span>

<span class="nc" id="L257">        return cooperationReportDetailVO;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>